{% extends "templates/web.html" %}
{% from "erpnext/templates/includes/order/order_macros.html" import item_name_and_description %}

{% block breadcrumbs %}
	{% include "templates/includes/breadcrumbs.html" %}
{% endblock %}

{% block title %}{{ doc.name }}{% endblock %}

{% block header %}
	<h2 class="m-0">{{ doc.name }}</h2>
{% endblock %}

{% block header_actions %}
	<div class="dropdown">
		<button class="btn btn-outline-secondary dropdown-toggle" data-toggle="dropdown" aria-expanded="false">
			<span class="font-md">{{ _('Actions') }}</span>
			<b class="caret"></b>
		</button>
		<ul class="dropdown-menu dropdown-menu-right" role="menu">
			{% if doc.doctype == 'Purchase Order' %}
				<a class="dropdown-item" href="/api/method/erpnext.buying.doctype.purchase_order.purchase_order.make_purchase_invoice_from_portal?purchase_order_name={{ doc.name }}" data-action="make_purchase_invoice">{{ _("Make Purchase Invoice") }}</a>
			{% endif %}
			{% if doc.doctype == 'Quotation' %}
				{% if doc.docstatus == 0 %}
					<button class="dropdown-item approve-quote" data-action="approve-quote" data-name="{{doc.name}}">{{ _("Approve Quote") }}</button>
				{% endif %}
			{% endif %}
			<a class="dropdown-item" href='/printview?doctype={{ doc.doctype}}&name={{ doc.name }}&format={{ print_format }}'
				target="_blank" rel="noopener noreferrer">
				{{ _("Print") }}
			</a>
		</ul>
	</div>
{% endblock %}

{% block page_content %}
	<div class="row transaction-subheading">
		<div class="col-6">
			<span class="font-md indicator-pill {{ doc.indicator_color or ("blue" if doc.docstatus==1 else "darkgrey") }}">
				{% if doc.doctype == "Quotation" and not doc.docstatus %}
					{{ _("Pending") }}
				{% else %}
					{{ _(doc.get('indicator_title')) or _(doc.status) or _("Submitted") }}
				{% endif %}
			</span>
		</div>
		<div class="col-6 text-muted text-right small pt-3">
			{{ frappe.utils.format_date(doc.transaction_date, 'medium') }}
			{% if doc.valid_till %}
			<p>
			{{ _("Valid Till") }}: {{ frappe.utils.format_date(doc.valid_till, 'medium') }}
			</p>
			{% endif %}
		</div>
	</div>

	<p class="small my-3">
		{%- set party_name = doc.supplier_name if doc.doctype in ['Supplier Quotation', 'Purchase Invoice', 'Purchase Order'] else doc.customer_name %}
		<b>{{ party_name }}</b>

		<!-- {% if doc.contact_display and doc.contact_display != party_name %}
			<br>
			{{ doc.contact_display }}
		{% endif %} -->
	</p>

	{% if doc._header %}
		{{ doc._header }}
	{% endif %}

	<div class="order-container">
		<!-- items -->
		<table class="order-item-table w-100 table">
			<thead class="order-items order-item-header">
				<th width="60%">
					{{ _("Item") }}
				</th>
				<th width="20%" class="text-right">
					{{ _("Quantity") }}
				</th>
				<th width="20%" class="text-right">
					{{ _("Amount") }}
				</th>
				{% if doc.doctype == 'Quotation' %}
				<th width="20%" class="text-right">
					{{ _("Action Update") }}
				</th>
				{% endif %}
			</thead>
			<tbody>
			{% for d in doc.items %}
			<tr class="order-items">
				<td>
					{{ item_name_and_description(d) }}
				</td>
				<td class="text-right">
					{{ d.qty }}
					{% if d.delivered_qty is defined and d.delivered_qty != None %}
						<p class="text-muted small">{{ _("Delivered") }}&nbsp;{{ d.delivered_qty }}</p>
					{% endif %}
				</td>
				<td class="text-right">
					{{ d.get_formatted("amount")	 }}
					<p class="text-muted small">{{ _("Rate:") }}&nbsp;{{ d.get_formatted("rate") }}</p>
				</td>
				{% if doc.doctype == 'Quotation' %}
				<td class="text-right">
					{% if d.rate_accepted %}
						<button data-action="approve_quotation_items" data-name="{{d.name}}" docname="{{doc.name}}" class="btn btn-primary btn-sm accept-quote-item" disabled>{{ _("Accepted") }}</button>
					{% else %}
						<button data-action="approve_quotation_items" data-name="{{d.name}}" docname="{{doc.name}}" class="btn btn-primary btn-sm accept-quote-item">{{ _("Accept") }}</button>
					{% endif %}
				</td>
				{% endif %}
			</tr>
			{% endfor %}
			</tbody>
		</table>
		<!-- taxes -->
		<div class="order-taxes d-flex justify-content-end">
			<table>
				{% include "erpnext/templates/includes/order/order_taxes.html" %}
			</table>
		</div>
	</div>

	{% if enabled_checkout and ((doc.doctype=="Sales Order" and doc.per_billed <= 0)
		or (doc.doctype=="Sales Invoice" and doc.outstanding_amount > 0)) %}
		<div class="panel panel-default">
			<div class="panel-heading">
				<div class="row">
					<div class="form-column col-sm-6 address-title">
						<strong>Payment</strong>
					</div>
				</div>
			</div>
			<div class="panel-collapse">
				<div class="panel-body text-muted small">
					<div class="row">
						<div class="form-column col-sm-6">
							{% if available_loyalty_points %}
							<div class="form-group">
								<div class="h6">Enter Loyalty Points</div>
								<div class="control-input-wrapper">
									<div class="control-input">
										<input class="form-control" type="number" min="0" max="{{ available_loyalty_points }}" id="loyalty-point-to-redeem">
									</div>
									<p class="help-box small text-muted d-none d-sm-block"> Available Points: {{ available_loyalty_points }} </p>
								</div>
							</div>
							{% endif %}
						</div>

						<div class="form-column col-sm-6">
							<div id="loyalty-points-status" style="text-align: right"></div>
							<div class="page-header-actions-block" data-html-block="header-actions">
								<p class="mt-2" style="float: right;">
									<a href="/api/method/erpnext.accounts.doctype.payment_request.payment_request.make_payment_request?dn={{ doc.name }}&dt={{ doc.doctype }}&submit_doc=1&order_type=Shopping Cart"
										class="btn btn-primary btn-sm"
										id="pay-for-order">
										{{ _("Pay") }} {{ doc.get_formatted("grand_total") }}
									</a>
								</p>
							</div>
						</div>

					</div>

				</div>
			</div>
		</div>
	{% endif %}


	{% if attachments %}
		<div class="order-item-table">
			<div class="row order-items order-item-header text-muted">
				<div class="col-sm-12 h6 text-uppercase">
					{{ _("Attachments") }}
				</div>
			</div>
			<div class="row order-items">
				<div class="col-sm-12">
					{% for attachment in attachments %}
					<p class="small">
						<a href="{{ attachment.file_url }}" target="blank"> {{ attachment.file_name }} </a>
					</p>
					{% endfor %}
				</div>
			</div>
		</div>
	{% endif %}
	</div>

	{% set sales_order = doc.get("sales_order")%}
	{% if doc.doctype == "Quotation" and sales_order %}
		<div class="mt-6 w-100 alert alert-warning">
			Sales Order <a href="/orders/{{sales_order}}">{{ sales_order }}</a> has
			been generated for pre-negotiated items.
			<a href="/orders/{{sales_order}}">Go to Sales Order ?</a>
		</div>
		<style>
			.alert-warning {
				color: #bf9419;
				background-color: #fff4d3;
				border-color: #ffe594;
				font-size: 14px;
			}
		</style>
	{% endif %}

	{% if doc.terms %}
		<div class="terms-and-condition text-muted small">
			<hr><p>{{ doc.terms }}</p>
		</div>
	{% endif %}
{% endblock %}

{% block script %}
	<script> {% include "templates/pages/order.js" %} </script>
	<script>
		window.doc_info = {
			customer: '{{doc.customer}}',
			doctype: '{{ doc.doctype }}',
			doctype_name: '{{ doc.name }}',
			grand_total: '{{ doc.grand_total }}',
			currency: '{{ doc.currency }}'
		}
	</script>
	<script>
		frappe.ready(() => {
			$(".accept-quote-item").on("click", (e) => {
				const $btn = $(e.currentTarget);
				frappe.call({
				method: 'alfarsi_erpnext.alfarsi_erpnext.customer.approve_quotation_items',
				args: {
					quotation_item: $btn.data('name')
				},
				callback: (value) => {
					$btn.prop('disabled', true);
					$btn.html('Accepted')
				}
				})
			});
		});
	</script>
	<script>
		frappe.ready(() => {
			$(".approve-quote").on("click", (e) => {
				const $btn = $(e.currentTarget);
				frappe.call({
				method: 'alfarsi_erpnext.alfarsi_erpnext.customer.approve_quote',
				args: {
					name: $btn.data('name')
				},
				callback: (value) => {
					if (value.message) {
						$btn.prop('disabled', true);
						frappe.msgprint('Order approved successfully.')
					} else {
						frappe.msgprint('Auto approval failed. Please contact the sales person')
					}
				}
				})
			});
		});
	</script>
{% endblock %}
